/**
 * requires that the host class has an items[] array
 * which will be managed by the methods:
 * add()
 * remove()
 * contains()
 * forEach()
 */Ext.define("collection.Collection",{add:function(a){Ext.isArray(a)?Ext.Array.forEach(a,function(a){Ext.Array.include(this.items,a)},this):Ext.Array.include(this.items,a)},remove:function(a){Ext.isArray(a)?Ext.Array.forEach(a,function(a){Ext.Array.remove(this.items,a)},this):Ext.Array.remove(this.items,a)},contains:function(a){return Ext.Array.contains(this.items,a)},forEach:function(a,b){Ext.Array.forEach(this.items,a,b||this)},query:function(a){return Ext.Array.filter(this.items,function(b){var c=!1;for(var d in a)if(a.hasOwnProperty(d))if(b[d]&&b[d]===a[d])c=!0;else{c=!1;break}return c})},asArray:function(){return Ext.Array.clone(this.items)}}),Ext.define("motion.Velocity",{setVelocity:function(a,b,c){this.vx=a,this.vy=b,c!==undefined&&(this.av=c)},move:function(){this.x+=this.vx,this.y+=this.vy,this.av&&(this.rotation+=this.av)}}),Ext.namespace("canvasutils"),function(){function f(a,b,c){return e(a,b,c)||e(a,c,b)}function e(a,c,d){var e=!1,f=c.points,g=d.points,h,i;a.save(),a.translate(c.x,c.y),a.beginPath(),a.moveTo(f[0].x,f[0].y);for(var j=1;j<f.length;j++)h=f[j],a.lineTo(h.x,h.y);a.closePath();for(var k=0;k<g.length;k++){i=g[k];if(b(a,d.x+i.x,d.y+i.y,c.x,c.y)){e=!0;break}}a.restore();return e}var a="none",b,c,d;c=document.createElement("canvas"),c&&c.getContext&&(d=c.getContext("2d"),d.save(),d.translate(10,10),d.rect(0,0,10,10),d.isPointInPath(5,5)?a="local":d.isPointInPath(15,15)&&(a="global"),b=function(){if(a==="global")return function(a,b,c){return a.isPointInPath(b,c)};if(a==="local")return function(a,b,c,d,e){return a.isPointInPath(b-d,c-e)}}()),Ext.define("canvasutils.CanvasUtils",{statics:{isPointInPath:b,polygonsIntersect:f}})}(),Ext.define("drawable.Drawable",{initDrawable:function(a){if(!a.ctx)throw new Error("Sprite requires a context property");this.ctx=a.ctx},beforeDraw:function(){this.ctx.save(),this.ctx.translate(this.x,this.y),this.strokeStyle&&(this.ctx.strokeStyle=this.strokeStyle),this.fillStyle&&(this.ctx.fillStyle=this.fillStyle),this.rotation&&this.rotation&&this.ctx.rotate(this.rotation)},draw:function(){this.beforeDraw();var a=this.getPoint(0),b=this.points.slice(1);this.ctx.beginPath(),this.ctx.moveTo(a.x,a.y),Ext.Array.forEach(b,function(a,b,c){this.ctx.lineTo(a.x,a.y)},this),this.ctx.closePath(),this.ctx.stroke(),this.afterDraw()},afterDraw:function(){this.ctx.restore()}}),Ext.define("interactive.Clickable",{onClick:function(a,b){a&&(this.click=Ext.Function.bind(a,b))},noClick:function(){this.click=null}}),Ext.define("interactive.Draggable",{onStartDrag:function(a,b){a&&(this.startdrag=Ext.Function.bind(a,b))},noStartDrag:function(){this.startdrag=null},onDrag:function(a,b){a&&(this.drag=Ext.Function.bind(a,b))},noDrag:function(){this.drag=null},onEndDrag:function(a,b){a&&(this.enddrag=Ext.Function.bind(a,b))},noEndDrag:function(){this.enddrag=null}}),Ext.define("soundeffects.SoundEffects",{statics:{sounds:{},defineSounds:function(a){var b=this;this.sounds=Ext.apply(this.sounds,a),window.soundManager.onready(function(){b.loadSounds()})},loadSounds:function(){console.log("loadSounds",this.sounds);for(var a in this.sounds)this.sounds.hasOwnProperty(a)&&window.soundManager.createSound({id:a,url:this.sounds[a]})},play:function(a,b){this.sounds[a]&&(b?window.soundManager.play(a,b):window.soundManager.play(a))}}}),Ext.define("eventbus.EventBus",{statics:{events:{},defineEvent:function(a){this.events[a]=[]},publish:function(a,b){if(this.events.hasOwnProperty(a))for(var c=0;c<this.events[a].length;c++){var d=this.events[a][c];d.callback.call(d.subscriber,b)}},subscribe:function(a,b,c){this.events.hasOwnProperty(a)&&this.events[a].push({subscriber:c,callback:b})}}}),Ext.define("oop.InitProps",{constructor:function(a){a&&Ext.apply(this,a)},applyProps:function(a,b){return[Ext.applyIf(a,b||{})]}}),Ext.define("geometry.Point",{extend:"oop.InitProps",constructor:function(a){this.callParent([Ext.applyIf(a,{x:0,y:0})])}}),Ext.define("geometry.Path",{extend:"geometry.Point",constructor:function(a){this.callParent(this.applyProps(a,{points:[]}))},addPoint:function(a){this.points.push(a)},getPoint:function(a){return this.points[a]},clearPoints:function(){this.points=[]},setPointsFromArray:function(a){this.clearPoints(),Ext.Array.forEach(a,function(a){this.addPoint(new geometry.Point({x:a.x,y:a.y}))},this)}}),Ext.define("controller.Keyboard",{extend:"oop.InitProps",statics:{keys:{16:"shift",17:"ctrl",18:"alt",32:"space",19:"pause",37:"left",38:"up",39:"right",40:"down"},getKey:function(a){var b=a||event,c=this.keys[b.keyCode];return c||""}},context:window,keyUp:Ext.emptyFn,keyPress:Ext.emptyFn,constructor:function(a){this.callParent([a]),document.onkeydown=Ext.Function.bind(this.onKeyPress,this),document.onkeyup=Ext.Function.bind(this.onKeyUp,this)},onKeyPress:function(a){var b=this.self.getKey(a);this.keyPress.call(this.context,b)},onKeyUp:function(a){var b=this.self.getKey(a);this.keyUp.call(this.context,b)}}),Ext.define("collision.Collision",{requires:["canvasutils.CanvasUtils"],containsPoint:function(a,b){var c;this.ctx.save(),this.ctx.translate(this.x,this.y),this.ctx.beginPath(),this.ctx.moveTo(this.points[0].x,this.points[0].y);for(var d=0;d<this.points.length;d++){var e=this.points[d];this.ctx.lineTo(e.x,e.y)}this.ctx.closePath(),c=canvasutils.CanvasUtils.isPointInPath(this.ctx,a,b,this.x,this.y),this.ctx.restore();return c},intersects:function(a){return canvasutils.CanvasUtils.polygonsIntersect(this.ctx,this,a)}}),Ext.define("geometry.Shape",{extend:"geometry.Path",requires:["canvasutils.CanvasUtils"],constructor:function(a){this.callParent([Ext.applyIf(a,{rotation:0,scale:1})])}}),Ext.define("sprites.Sprite",{extend:"geometry.Shape",mixins:["motion.Velocity","drawable.Drawable","collision.Collision"],constructor:function(a){this.callParent([a]),this.initDrawable(this.context)}}),Ext.define("geometry.Square",{extend:"geometry.Shape",requires:["geometry.Point"],constructor:function(a){this.callParent([Ext.applyIf(a,{width:100,height:100})]),this.setPointsFromArray([{x:0,y:0},{x:this.width,y:0},{x:this.width,y:this.height},{x:0,y:this.height}])}}),Ext.define("geometry.Plane",{extend:"geometry.Square",constructor:function(a){this.callParent(this.applyProps(a,{wrap:!1}))}}),Ext.define("sprites.ShipFragment",{extend:"sprites.Sprite",constructor:function(a){this.callParent([Ext.applyIf(a,{strokeStyle:"#FF0000"})])},update:function(){this.move()},draw:function(){this.beforeDraw(),this.ctx.save(),this.ctx.translate(0,-this.length/2),this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(0,this.length),this.ctx.restore(),this.ctx.stroke(),this.afterDraw()}}),function(){var a=Math.PI*2,b=function(a){return Math.random()*a};Ext.define("sprites.Rock",{extend:"sprites.Sprite",requires:["canvasutils.CanvasUtils"],constructor:function(a){this.callParent([Ext.applyIf(a,{active:!0,size:3})]),this.init(a)},init:function(c){var d=c.parent;this.clearPoints(),this.size=c.size,this.size===3?(this.num_points=16,this.radius=60):this.size===2?(this.num_points=12,this.radius=30):this.size===1&&(this.num_points=6,this.radius=8);var e=this.radius*.7,f=this.radius*.3;this.ang_incr=a/this.num_points;var g=0;for(var h=0;h<this.num_points;h++){g+=this.ang_incr;var i=e+b(f);this.addPoint({x:i*Math.cos(g),y:i*Math.sin(g)})}d?(this.bearing=(d.bearing+b(a))/2,this.vx=(d.vx+c.speed)*Math.cos(this.bearing),this.vy=(d.vy+c.speed)*Math.sin(this.bearing)):(this.bearing=b(a),this.vx=c.speed*Math.cos(this.bearing),this.vy=c.speed*Math.sin(this.bearing))},update:function(){this.move(),this.checkWrap()},checkWrap:function(){var a=this.radius,b=this.context.canvas_width,c=this.context.canvas_height;this.x>b+a?this.x=-a:this.x<-a&&(this.x=b+a),this.y>c+a?this.y=-a:this.y<-a&&(this.y=c+a)}})}(),Ext.define("drawable.DrawableSquare",{extend:"geometry.Square",mixins:["drawable.Drawable"],constructor:function(a){this.callParent([Ext.applyIf(a,{fillStyle:"",strokeStyle:"#FF0000",context:null})]),this.initDrawable(this.context)},draw:function(){this.beforeDraw(),this.fillStyle&&this.ctx.fillRect(0,0,this.width,this.height),this.strokeStyle&&this.ctx.strokeRect(0,0,this.width,this.height),this.afterDraw()}}),Ext.define("sprites.Point",{extend:"drawable.DrawableSquare",mixins:["motion.Velocity","collision.Collision"],constructor:function(a){this.callParent([a])}}),Ext.define("canvasutils.Context2D",{extend:"geometry.Plane",constructor:function(a){this.callParent(this.applyProps(a,{canvasId:"canvas",bg:"#000000",strokeStyle:"#00FF00",fillStyle:"#FF0000",fullscreen:!0})),this.canvas=document.getElementById(this.canvasId),this.ctx=this.canvas.getContext("2d"),this.resize(),this.reset()},resize:function(){this.fullscreen&&(this.canvas_width=document.documentElement.clientWidth,this.canvas_height=document.documentElement.clientHeight),this.width=this.canvas_width,this.height=this.canvas_height,console.log("resized to ",this.width,this.height),this.canvas.setAttribute("width",this.canvas_width),this.canvas.setAttribute("height",this.canvas_height)},reset:function(){this.ctx.fillRect(0,0,this.canvas_width,this.canvas_height),this.ctx.strokeStyle="#00FF00",this.ctx.font="24px Verdana,Arial,sans-serif"},applyStroke:function(a){this.ctx.strokeStyle=a},applyFill:function(a){this.ctx.fillStyle=a}}),Ext.define("ui.Component",{extend:"drawable.DrawableSquare",mixins:["collision.Collision","interactive.Clickable"],constructor:function(a){this.callParent(this.applyProps(a,{active:!0,clickable:!0}))}}),Ext.define("sprites.Bullet",{extend:"sprites.Point",requires:["eventbus.EventBus"],constructor:function(a){this.callParent([Ext.applyIf(a,{width:2,height:2,dx:0,dy:0,vx:0,vy:0})])},update:function(){var a=this.context.width,b=this.context.height;this.move(),this.dx+=Math.abs(this.vx),this.dy+=Math.abs(this.vy);this.dx>a*.6||this.dy>b*.6?eventbus.EventBus.publish("bulletExpired",this):(this.x<0?this.x+=a:this.x>a&&(this.x-=a),this.y<0?this.y+=b:this.y>b&&(this.y-=b))}}),Ext.define("drawable.Layer",{extend:"canvasutils.Context2D",mixins:["collection.Collection"],constructor:function(a){this.callParent(this.applyProps(a,{items:[]}))},update:function(){this.forEach(function(a){a.active!==!1&&a.update&&a.update()})},render:function(){var a;for(var b=0;b<this.items.length;b++){a=this.items[b];if(a.active===!1)continue;a.draw()}}}),Ext.define("interactive.ClickableLayer",{extend:"drawable.Layer",constructor:function(a){this.callParent([a]);var b=this,c=this.canvas;this.canvas.addEventListener("click",Ext.Function.bind(this.onClick,this),!1),this.canvas.addEventListener("click",function(a){b.handleEvent("click",a)},!1)},onClick:function(a){console.log("click",a),this.handleEvent("click",a)},handleEvent:function(a,b){var c=event.clientX-this.canvas.offsetLeft,d=event.clientY-this.canvas.offsetTop;this.items.forEach(function(b){b.active&&b[a]&&b.containsPoint(c,d)&&b[a](c-b.x,d-b.y)})}}),Ext.define("ui.Button",{extend:"ui.Component",constructor:function(a){this.callParent(this.applyProps(a,{text:"Button"}))},draw:function(){this.beforeDraw();var a=this.ctx.measureText(this.text);this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillStyle="#00FF00",this.ctx.fillText(this.text,(this.width-a.width)/2,this.height/2),this.ctx.beginPath(),this.ctx.rect(0,0,this.width,this.height),this.ctx.stroke(),this.afterDraw()}}),Ext.define("controller.TouchPad",{extend:"ui.Component",mixins:["interactive.Draggable"],constructor:function(a){this.callParent(this.applyProps(a,{strokeStyle:"#FF0000",width:200,height:200,drags:{}})),this.onStartDrag(function(a,b,c){console.log("dragstart",a,b)}),this.onDrag(function(a,b,c){console.log("drag",a,b)})}}),function(){var a=Math.PI*2,b=function(a){return Math.random()*a},c=30,d=1,e,f=25,g=15;Ext.define("sprites.Ship",{extend:"sprites.Sprite",requires:["sprites.Bullet"],constructor:function(a){this.callParent([Ext.applyIf(a,{active:!0})]),this.height=25,this.width=15,this.baseAngle=Math.atan2(this.height,this.width/2),this.setPointsFromArray([Ext.create("geometry.Point",{x:-this.width/2,y:this.height/2}),Ext.create("geometry.Point",{x:0,y:-this.height/2}),Ext.create("geometry.Point",{x:this.width/2,y:this.height/2})])},init:function(){this.x=this.context.canvas_width/2,this.y=this.context.canvas_height/2,this.turn_speed=a/60,this.rotation=0,this.rv=0,this.setVelocity(0,0),this.acc=0,this.mass=5,this.force=0,this.friction=.998,this.thrust=!1},reset:function(){this.init()},rotate:function(a){this.rv=a*this.turn_speed},turnRight:function(){this.rotate(1)},turnLeft:function(){this.rotate(-1)},stopTurningRight:function(){this.rv>0&&this.rotate(0)},stopTurningLeft:function(){this.rv<0&&this.rotate(0)},startThrust:function(){this.thrust=!0,this.force=-1.1},stopThrust:function(){this.thrust=!1,this.force=0},update:function(){var a,b,c,d,e=5;this.rotation=this.rotation+this.rv;var f=this.context.canvas_width,h=this.context.canvas_height;this.thrust&&(a=this.force/this.mass,b=this.rotation+Math.PI/2,c=a*Math.cos(b),d=a*Math.sin(b),this.vx+=c,this.vy+=d),this.x<0?this.x+=f:this.x>f&&(this.x-=f),this.y<0?this.y+=h:this.y>h&&(this.y-=h),this.vx>g?this.vx=g:this.vx<-g&&(this.vx=-g),this.vy>g?this.vy=g:this.vy<-g&&(this.vy=-g),this.move(),this.exploding&&this.animateExplosion()}})}(),Ext.define("interactive.DraggableLayer",{extend:"interactive.ClickableLayer",mixins:["interactive.Draggable"],constructor:function(a){function c(a){var b;a.changedTouches&&(b=a.changedTouches[0],b.type=a.type);return b||a}this.callParent([a]);var b=this;this.dragging=!1,this.canvas.addEventListener("touchstart",function(a){b._mousedown(c(a))},!1),this.canvas.addEventListener("touchmove",function(a){a.preventDefault(),b._mousemove(c(a))},!1),this.canvas.addEventListener("touchend",function(a){b._mouseup(c(a))},!1),this.canvas.addEventListener("mousedown",Ext.Function.bind(this._mousedown,this),!1)},_mousedown:function(a){a.type==="touchstart"&&this.canvas.removeEventListener("mousedown",Ext.Function.bind(this._mousedown,this),!1),a.type==="mousedown"&&(this.dragging=!0,this.canvas.addEventListener("mousemove",Ext.Function.bind(this._mousemove,this),!1),this.canvas.addEventListener("mouseup",Ext.Function.bind(this._mouseup,this),!1)),this._startdrag(a)},_mousemove:function(a){a.type==="touchmove"?this._drag(a):a.type==="mousemove"&&this.dragging&&this._drag(a)},_mouseup:function(a){a.type==="touchend"?this._enddrag(a):a.type==="mouseup"&&this.dragging&&(this._enddrag(a),this.dragging=!1,this.canvas.removeEventListener("mousemove",Ext.Function.bind(this._mousemove,this),!1),this.canvas.removeEventListener("mouseup",Ext.Function.bind(this._mouseup,this),!1))},_startdrag:function(a){this.handleEvent("startdrag",a)},_drag:function(a){this.handleEvent("drag",a)},_enddrag:function(a){this.handleEvent("enddrag",a)},handleEvent:function(a,b){var c=b.clientX-this.canvas.offsetLeft,d=b.clientY-this.canvas.offsetTop;this.items.forEach(function(e){e.active&&e[a]&&e.containsPoint(c,d)&&e[a](c-e.x,d-e.y,b.identifier||"single")}),this[a]&&this[a](c-this.x,d-this.y)}}),function(){var a=Math.PI*2,b=function(a){return Math.random()*a},c=30,d=1,e,f=25,g=15;Ext.define("Asteroids",{extend:"oop.InitProps",requires:["eventbus.EventBus","controller.TouchPad","soundeffects.SoundEffects","sprites.Rock","sprites.Ship","sprites.ShipFragment","sprites.Bullet","drawable.Layer","controller.Keyboard","ui.Button","interactive.DraggableLayer"],constructor:function(a){this.callParent([a]),this.rocks=[],this.bullets=[];var b=this;window.onresize=function(){var a;a&&clearInterval(a),a=setTimeout(function(){b.state("resize")},200)},this.gameLayer=new interactive.DraggableLayer({x:0,y:0,fullscreen:!0,canvasId:this.canvasId,stroke:this.stroke}),this.keyboard=new controller.Keyboard({context:this,keyPress:this.onKeyPress,keyUp:this.onKeyUp}),this.touchPad=new controller.TouchPad({context:this.gameLayer,x:0,y:0,width:this.gameLayer.canvas_width/2,height:this.gameLayer.canvas_height}),this.gameLayer.add(this.touchPad),this.ship=new sprites.Ship({active:!1,context:this.gameLayer,strokeStyle:"#FF0000"}),this.gameLayer.add(this.ship),eventbus.EventBus.defineEvent("bulletExpired"),eventbus.EventBus.subscribe("bulletExpired",this.onBulletExpired,this),this.startButton=new ui.Button({text:"Play",width:120,height:40,x:this.gameLayer.width/2-100,y:this.gameLayer.height/2-20,active:!1,context:this.gameLayer}),this.gameLayer.add(this.startButton),soundeffects.SoundEffects.defineSounds({laser:"../../lib/sounds/laser.mp3",rock_explode:"../../lib/sounds/explode.mp3",thrust:"../../lib/sounds/thrust.mp3",boom:"../../lib/sounds/boom.mp3",asteroids_loop:"../../lib/sounds/asteroids_loop.mp3"}),this.sfx=soundeffects.SoundEffects},startLevel:function(){this.makeRocks(),this.changeState(this.PLAY)},changeState:function(a){this.state&&this.state("exit"),this.state=a,this.state("enter")},stopTimer:function(){e&&clearInterval(e),e=null},coastIsClear:function(){var a,b,c=100,d;for(var e=0;e<this.rocks.length;e++){d=this.rocks[e];if(!d.active)continue;a=d.x,b=d.y;if(a>this.ship.x-c&&a<this.ship.x+c&&b>this.ship.y-c&&b<this.ship.y+c)return!1}return!0},addRock:function(a){this.rocks.push(a),this.gameLayer.add(a)},removeRock:function(a){Ext.Array.remove(this.rocks,a),this.gameLayer.remove(a)},removeAllRocks:function(){Ext.Array.forEach(this.rocks,function(a){this.removeRock(a)},this)},makeRocks:function(){this.removeAllRocks();var a=Math.round(d*.25*24),c;for(var e=0;e<a;e++){c=new sprites.Rock({strokeStyle:"#00FF00",context:this.gameLayer,x:b(this.gameLayer.canvas_width),y:b(this.gameLayer.canvas_height),size:3,speed:1});if(this.ship&&this.state===this.START_LEVEL&&c.intersects(this.ship)){a++;continue}this.addRock(c)}},start:function(){this.changeState(this.START_GAME)},onBulletExpired:function(a){this.removeBullet(a)},addBullet:function(a){this.bullets.push(a),this.gameLayer.add(a)},removeBullet:function(a){Ext.Array.remove(this.bullets,a),this.gameLayer.remove(a)},removeAllBullets:function(){Ext.Array.forEach(this.bullets,function(a){this.removeBullet(a)},this)},fireBullet:function(){var a=8,b=this.ship.rotation-Math.PI/2,c=this.ship.height/2;this.addBullet(new sprites.Bullet({dx:0,dy:0,x:this.ship.x+c*Math.cos(b),y:this.ship.y+c*Math.sin(b),vx:this.ship.vx+a*Math.cos(b),vy:this.ship.vy+a*Math.sin(b),context:this.gameLayer})),this.sfx.play("laser")},bulletHitRock:function(a){var b,c;c=this.gameLayer.ctx;for(var d=0;d<this.bullets.length;d++){b=this.bullets[d];if(a.containsPoint(b.x,b.y)){this.removeBullet(b);return!0}}return!1},explodeRock:function(a){var c,d;if(a.size>1)for(var e=0;e<3;e++)this.addRock(new sprites.Rock({context:this.gameLayer,x:a.x,y:a.y,size:a.size-1,speed:b(3),parent:a}));this.removeRock(a),this.sfx.play("rock_explode")},hitRock:function(a,b){var c=a.height+b.radius;return Math.abs(a.x-b.x)>c||Math.abs(a.y-b.y)>c?!1:a.intersects(b)},rocksLeft:function(){return this.rocks.length>0},bulletsLeft:function(){return this.bullets.length>0},startTimer:function(){var a=this;e||(e=setInterval(function(){a.state("tick")},1e3/c))},resize:function(){this.startButton.x=this.gameLayer.canvas_width/2-this.startButton.width/2,this.startButton.y=this.gameLayer.canvas_height/2-this.startButton.height/2,this.gameLayer.resize(),this.touchPad.width=this.gameLayer.canvas_width/2,this.touchPad.height=this.gameLayer.canvas_height},reset:function(){this.gameLayer.reset()},explodeShip:function(a){this.ship.active=!1,this.shipFragments=[new sprites.ShipFragment({x:a.x+a.points[0].x,y:a.y+a.points[0].y,av:b(.05)-b(.025),rotation:Math.atan2(a.points[1].y,a.points[1].x),length:Math.sqrt(a.width/2*(a.width/2)+a.height*a.height),vx:b(2)-Math.random(),vy:b(2)-Math.random(),context:this.gameLayer}),new sprites.ShipFragment({x:a.x+a.points[1].x,y:a.y+a.points[1].y,av:b(.05)-b(.025),rotation:Math.atan2(a.points[2].y,a.points[2].x),length:Math.sqrt(a.width/2*(a.width/2)+a.height*a.height),vx:b(2)-Math.random(),vy:b(2)-Math.random(),context:this.gameLayer}),new sprites.ShipFragment({x:a.x+a.points[0].x,y:a.y+a.points[0].y,av:b(.05)-b(.025),rotation:0,length:a.width,vx:b(2)-Math.random(),vy:b(2)-Math.random(),context:this.gameLayer})],this.gameLayer.add(this.shipFragments),this.sfx.play("boom")},handleInput:function(a){switch(a){case"right_keypress":this.ship.turnRight();break;case"left_keypress":this.ship.turnLeft();break;case"left_keyup":this.ship.stopTurningLeft();break;case"right_keyup":this.ship.stopTurningRight();break;case"up_keypress":this.ship.startThrust(),this.sfx.play("thrust");break;case"up_keyup":this.ship.stopThrust();break;case"spacebar":this.fireBullet();break;case"resize":this.resize(),this.reset();break;default:}},onKeyPress:function(a){switch(a){case"left":this.state("left_keypress");break;case"right":this.state("right_keypress");break;case"up":this.state("up_keypress");break;case"space":this.state("spacebar");break;default:}},onKeyUp:function(a){switch(a){case"left":this.state("left_keyup");break;case"right":this.state("right_keyup");break;case"up":this.state("up_keyup");break;default:}},START_GAME:function(a){var b=this;this.startButton.active=!0,this.startButton.onClick(function(){this.changeState(this.START_LIFE)},this);switch(a){case"enter":this.makeRocks(),this.startTimer();break;case"tick":this.reset(),this.gameLayer.update(),this.gameLayer.render();break;case"exit":break;default:this.handleInput(a)}},END_LEVEL:function(a){var b=this;switch(a){case"enter":setTimeout(function(){b.startLevel()},5e3),this.startTimer();break;case"tick":this.reset(),this.gameLayer.update(),this.gameLayer.render();break;case"exit":break;default:this.handleInput(a)}},START_LIFE:function(a){switch(a){case"enter":this.startButton.active=!1,this.ship.init(),this.startTimer();break;case"tick":this.reset(),this.gameLayer.update(),this.gameLayer.render(),this.coastIsClear()&&this.changeState(this.PLAY);break;case"resize":this.resize(),this.reset();break;case"exit":break;default:}},PLAY:function(a){switch(a){case"enter":this.ship.active=!0,this.startTimer();break;case"tick":this.reset(),this.gameLayer.update();for(var b=0;b<this.rocks.length;b++){var c=this.rocks[b];this.hitRock(this.ship,c)&&(this.explodeShip(this.ship),this.changeState(this.END_LIFE)),this.bulletHitRock(c)&&this.explodeRock(c)}this.gameLayer.render(),this.rocksLeft()||this.changeState(this.END_LEVEL);break;case"exit":this.stopTimer();break;default:this.handleInput(a)}},END_LIFE:function(a){var b=this;switch(a){case"enter":this.startTimer(),setTimeout(function(){b.changeState(b.START_LIFE)},5e3);break;case"tick":this.reset(),this.gameLayer.update(),this.gameLayer.render();break;case"resize":this.resize(),this.reset();break;case"exit":this.gameLayer.remove(this.shipFragments);break;default:}}})}()